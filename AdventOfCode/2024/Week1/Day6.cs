

using System.Numerics;
using System.Text.RegularExpressions;

namespace AdventOfCode._2024
{
    internal class Day6() : Problem("....#.....\r\n.........#\r\n..........\r\n..#.......\r\n.......#..\r\n..........\r\n.#..^.....\r\n........#.\r\n#.........\r\n......#...",
        ".................#.#............................................#................#........................................#.......\r\n.....#.............................................................#.......#...#........................#...........#.......##....\r\n..........................................................#..#........#..........#...............#.#..................#...........\r\n..#...#..........#....#.....#......................................#......#..#............................#..#....................\r\n.........................#....#.............#....................................#............................................#...\r\n.....................#.......#.............#...#..........#.................#.......#...............#............#......#.........\r\n........#.........#.....................................#............#.....................##...#..#..........#...................\r\n....#...................#.....##......#............#...#........................#...................................#.............\r\n...............................................................................#.......#.....#...#................#.#......##.....\r\n..........................................#............................#.#.................................#.........#............\r\n........#...............#...............#...................##......#..................#...............#..........................\r\n.........................#....................................#..........#.........................................##.............\r\n.......#.................#..................................#......#....................#...............#..........#......#.......\r\n.............#.#...#.............#.............................................#...............................##.....#...#.......\r\n.....................................................#............................................#.........................#.....\r\n.#...#..........................................................##.................................#............#...............#.\r\n...........#..#........#.....#.............#.......#............................................#..............#.................#\r\n......#.#.##...............#.......#......#......................................................................#...............#\r\n...#........#.#.....................##...#...........................#..............................#...................#.........\r\n..............#..#....................#...................#.................##..............#.#........................#..........\r\n...........................................................#.........#.......................#......................#.........#...\r\n................................................#............................................#....................................\r\n..#.....................................................#..............#...#.........#.....#........................#.............\r\n.#..............................#......#..............#........................................................#..................\r\n#......#.....#..#..#........#....................#...........##..............................#..#.....#.....#.....................\r\n.................#.....#.....................#.........#..............................#..............##......................#....\r\n...........................................................#...##..............#..........................#....#..................\r\n........#..#............................#.#........................#.....#................#...#...................................\r\n..........................#........#.......................................................................##...................#.\r\n............#....#.............................................#.......#....#.....#........................................#......\r\n..........#............#....#.......................#.#............#..............................................................\r\n......#...#......................................................#..#.............................................................\r\n.#...#.....#.....#......................................................................................#..........#.....#........\r\n...#..#.............................................................................#.............................................\r\n............#...................#...........................................#..............#.....#.....................#.##.......\r\n.................................................#................................................................................\r\n.........................#.......................................#..................#..............................#..............\r\n................................................................................................................................#.\r\n...#...........................................#........#.................................................#......#................\r\n..#...........................................#.......#.....#.................................#....#.............#...............#\r\n........#..............#...................................................................................#......................\r\n...........#......#............#............#..................................#.........#..............#.........#..........#....\r\n.........................#.........#.....#.................................#..................#...............##..#...............\r\n.....#........#.........................................................#....................................#......#....#........\r\n...#..#.......#......#.#..................#..........................^#...........................................................\r\n....................#.#..........................................................................#...#............................\r\n...........................#..........................................................#...........................................\r\n................#..............................................................................#..................................\r\n...............................#............................................................#...................................#.\r\n..............#..........................................#..............#..................#..........#...........................\r\n................#...#..........................#.##..........#.......#..............................#........#..............#.....\r\n...................#.............#....................#...........................................................................\r\n....#....................................#....#................................................#..#...........#...................\r\n....#.#..............#..........#...................#...................................#....................#........#......#....\r\n...........................#...........#..#......#.......................................#.......................#......#.........\r\n.....................................................................................................#.................#..........\r\n...................................................#.............#..........#..............................#......................\r\n................................#...........##....................................................................#....#..........\r\n...........#.......#.......................................................................#............#.....................#...\r\n.#........#.......#........................................#.#...............................#...#...........................#....\r\n..#...............#................#....#............#................................................................#...........\r\n........#..........#.........#....................................................................................#...............\r\n............................................................................#.............................#...............#......#\r\n......................#................................#.............#...#............#...........................................\r\n................................#.............#.................................................................#..............#..\r\n.........#.#..#...............................#....................................................#.#.......#..#........#........\r\n.............................#.......#.....#......................................................#..#............................\r\n..................#.............................................................................#..........#......................\r\n.....................................#....##.................#......................................#....#........................\r\n#.......................................................................................................................#.........\r\n......#....#..#...........................#..#.....#........................................#..................................#..\r\n.......#.....#...............#....#......#....#..........#.....................#....#..........#.....#..#......................##.\r\n..................#..........#.....#........................................................#............##...................#...\r\n........................#....#............#..................................#....#..#.......#...................................#\r\n.....#............................#...............................#..#...................#.....#..#........#....#.#...............\r\n......#...#..#......#..........................#........#....................#.......#...........#..........................#..#..\r\n.....#.............................................................................................#......#......................#\r\n...........................................#......................................................................................\r\n.....#...........................#.#.#............................#..................#............................#.......#.......\r\n........#.......................................................#...................#.......#.....................................\r\n...............#..................................................#.................................................#.............\r\n..##............................................................#..............................................................#..\r\n.......#..................................#......................#.................................#...................#..........\r\n......#.........#..............#....##........#....#................................#.....................................#......#\r\n................#.....................................................................................#.............#.............\r\n#..#..#......#.#.....#..#.................................................................................................#..#....\r\n.....................#.....#................................................#.......#........#.................#........#.#...#...\r\n..................................................................#....#..#...................#................................#..\r\n........................#...........#.......................................................#..#..................................\r\n.#.......#...................................................#..............#.......#...#.........................................\r\n.......##...............#.............................#...........................#...............................................\r\n....#............#....#...#........................#...........................#.#.....#..........................................\r\n...........................#............................#..#..................#...........................#...#...................\r\n...........#.#.............#..........#...........................................................................................\r\n.............#..........#...............#...##.........................#..............#...#.............#..#......................\r\n..................#.....#............#..#.........#...............................................................................\r\n...........................................................#.....#..................#.......................#..#..................\r\n....................................#....#.......##............#.............................#...............#...........#........\r\n......#....................#..................#..........................................#...............................#.#......\r\n......................#...........................................#.....#.................................................#....#..\r\n.....................................#...............#....................................#.....#.............#......##...........\r\n......................#...............................................................##.#..........#....#..................#.....\r\n...........#.............#......................#....................#..................................#......#...........##.....\r\n.....#.#...#......................................................................................................................\r\n.........#.....................................#................#.............#....#......................#..........#............\r\n......##.#.................#...............#..##.......................#...............#.......................................#..\r\n....................#.........#.......#....#..................................#..........................#..............#.........\r\n......................#....#..#..#................................#.......#.......................................................\r\n.........................................##............................##..#..................#..................#...........#....\r\n...................#..................................#................................................................#..........\r\n.#.............#....................................................................................#.............................\r\n......................................#.....#.............#..#............................................#...#............#......\r\n.....................................#..................................#...#.......................##...................#........\r\n...........................................................#...................................................#...........#......\r\n.............................#.......#.......................................#.........................#.....................#...#\r\n.....................#............................................................................................................\r\n#....#.......................................#.........#........#...................................#.....#.........#........#....\r\n.......................................................#......#................................##.#........#.........#..........#.\r\n.........#........................##.....#.............................................................#.................#..#.....\r\n....##....................................................................................................#...#...#...............\r\n.......#.....#.......#.............#........#...............##.#......#...............#.................#..#.........#...#....#...\r\n....................#.................................#........................................................................#..\r\n#...............#....................................#.........#...............................#..#..........##...#...#......#....\r\n............#........................#.....#...#.........#.........#..#......................................#....................\r\n..........#.......#.#.....................#...........#...................#.##....................#..#...#........#..............#\r\n.......................................#.......#........#.....#...........................................#.......#......#........\r\n...............................#.........#..............#......................#..........................................#.#.....\r\n............#........#.............................................#.....................................................##......#\r\n......#.#............................................................................#......#.....#......#................#.......\r\n.........#.............#................#.................#..###..........#.........................#.#....#......................")
    {
        private Pos guardPos;
        private char guard;
        private List<Pos> history = [];
        protected override void Solve()
        {
            ConstructMatrix();
            //PrintMatrix(matrix);
            (guardPos, guard) = FindGuard();
            Pos newPos = guardPos;
            do
            {
                (guardPos, guard) = FindGuard();
                newPos = Move(); //could also call Problem.Move((int, int), char)
                if (!InBounds(newPos.x, newPos.y))
                {
                    matrix[guardPos.x, guardPos.y] = 'X';
                    if (!history.Contains(guardPos))
                        history.Add(guardPos);
                    break;
                }
                if (matrix.At(newPos) == '#')
                {
                    matrix[guardPos.x, guardPos.y] = Turn(guard);
                    continue;
                }
                (matrix[newPos.x, newPos.y], matrix[guardPos.x, guardPos.y]) = (matrix[guardPos.x, guardPos.y], matrix[newPos.x, newPos.y]);
                if (matrix.At(guardPos) != 'X')
                {
                    matrix[guardPos.x, guardPos.y] = 'X';
                    if (!history.Contains(newPos))
                        history.Add(newPos);
                }
            }
            while (InBounds(newPos.x, newPos.y));
            //PrintMap(matrix);
            if (part1)
            {
                result = matrix.MatrixFlattened().Where(x => x == 'X').Count();
            }
            else
            {
                LookForObstacles();
            }
        }

        private List<Task<bool>> tasks = [];

        private void LookForObstacles()
        {
            history.RemoveAt(0); // remove starting position
            ConstructMatrix(); //reset matrix
            int id = 1;
            foreach (Pos position in history)
            {
                (int, int) copy = position;
                tasks.Add(Task.Run(() => TestPosition(copy, id++)));
            }
            var resultsTask = Task.WhenAll(tasks);
            resultsTask.Wait();
            bool[] results = resultsTask.Result;

            foreach (bool success in results)
            {
                if (success)
                {
                    result++;
                }
            }
        }

        bool TestPosition(Pos position, int id = 0)
        {
            try
            {
                char[,] map = ConstructMatrixCopy();
                map[position.x, position.y] = '#';
                List<(Pos, char)> recordedPositions = [];
                (Pos gPos, char guard) = FindGuard();
                Pos newPos = gPos;
                do
                {
                    newPos = Move(gPos, guard);
                    if (recordedPositions.Contains((gPos, guard)))
                    {
                        return true;
                    }
                    recordedPositions.Add((gPos, guard));
                    if (!InBounds(newPos.x, newPos.y))
                    {
                        return false;
                    }
                    if (map.At(newPos) == '#')
                    {
                        guard = Turn(guard);
                        continue;
                    }
                    gPos = newPos;
                }
                while (InBounds(newPos.x, newPos.y));
                return false;
            }
            finally
            {
                Console.WriteLine($"Tested {id.ToString()}/{tasks.Count}");
            }
        }

        private void PrintMap(char[,] array)
        {
            Console.WriteLine();
            for (int j = 0; j < array.GetLength(1); j++)
            { 
                for (int i = 0; i < array.GetLength(0); i++)
                {
                    Console.Write(array[i, j]);
                }
                Console.WriteLine();
            }
        }

        private (int, int) Move()
        {
            return guard switch
            {
                '^' => (guardPos.x, guardPos.y - 1),
                'v' => (guardPos.x, guardPos.y + 1),
                '<' => (guardPos.x - 1, guardPos.y),
                '>' => (guardPos.x + 1, guardPos.y),
                _ => (0, 0)
            };
        }

        private char Turn(char guard)
        {
            return guard switch
            {
                'v' => '<',
                '>' => 'v',
                '<' => '^',
                '^' => '>',
                _ => '^'
            };
        }

        private ((int, int), char) FindGuard()
        {
            (int, int) result = guardPos;
            char ch = '^';
            MatrixForEach((i, j, c) =>
            {
                if (c == 'v' || c == '<' || c == '>' ||c == '^')
                {
                    result = (i, j);
                    ch = c;
                }
            });
            return (result, ch);
        }
    }
}
